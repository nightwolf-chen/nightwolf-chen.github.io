<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>队列是最为常见的的数据结构之一，每个合格的程序员都应该掌握如何实现一个队列，这里我讨论如何实现一个线程安全的可阻塞队列的实现。
</code></pre></div></div>

<p>完整代码请参考<a href="https://github.com/nightwolf-chen/JDCFFPlayer/blob/master/JDCFFMedia/jdc_sdl_queue.c">jdc_sdl_queue.c</a>。</p>

<h2 id="队列结构的定义">队列结构的定义</h2>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">JDCSDLPacketQueue</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">first_pk</span><span class="p">;</span><span class="c1">//链表头指针</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">last_pk</span><span class="p">;</span><span class="c1">//链表尾指针</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span><span class="c1">//当前size    </span>
    <span class="n">SDL_mutex</span> <span class="o">*</span><span class="n">mutex</span><span class="p">;</span><span class="c1">//互斥锁</span>
    <span class="n">SDL_cond</span> <span class="o">*</span><span class="n">cond</span><span class="p">;</span><span class="c1">//条件</span>
<span class="p">};</span>
</code></pre></div></div>
<h2 id="队列的基本操作">队列的基本操作</h2>
<p>经典的队列要要支持几个基本操作</p>
<ul>
  <li>Push 从末尾添加元素。</li>
  <li>pop 从头部移除元素，并返回头部的指针。</li>
  <li>front 获取头部的指针。
从队列的定义我们可以推断出使用单向链表来实现是非常方便的。我们需要定义一个链表的结构来就行数据的存储。我的链表node定义如下
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">JDCQueueNode</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">JDCQueueNode</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span><span class="n">JDCQueueNode</span><span class="p">;</span>
</code></pre></div>    </div>
    <p>我将数据指针存在Node的data字段，而data是一个通用指针，我们可以存放任意数据的指针。</p>
  </li>
</ul>

<p>让我们来看看队列相关方法的定义.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//为Queue动态分配内存。</span>
<span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">jdc_packet_queue_alloc</span><span class="p">();</span>
<span class="c1">//初始化队列，主要是初始化锁相关的内容。</span>
<span class="kt">void</span> <span class="n">jdc_packet_queue_init</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
<span class="c1">//获取当前的size</span>
<span class="kt">int</span> <span class="n">jdc_packet_queue_size</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
<span class="c1">//push</span>
<span class="kt">int</span> <span class="n">jdc_packet_queue_push</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="c1">//front</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">jdc_packet_queue_front</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
<span class="c1">//pop</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">jdc_packet_queue_pop</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
<span class="c1">//这个方法尝试获取队列头部的元素。Block参数为1时，如果不存在则会阻塞当前线程，直到有元素为止。</span>
<span class="kt">int</span> <span class="n">jdc_packet_queue_get_packet</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">data</span> <span class="p">,</span> <span class="kt">int</span> <span class="n">blockThread</span><span class="p">);</span>

</code></pre></div></div>

<h2 id="队列的实现">队列的实现</h2>
<p>队列的实现主要是对链表的操作，我们先来看看push的操作：</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">jdc_packet_queue_push</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">date</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//分配一个新的链表节点来存储数据</span>
    <span class="n">JDCQueueNode</span> <span class="o">*</span><span class="n">listNode</span> <span class="o">=</span> <span class="p">(</span><span class="n">JDCQueueNode</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">JDCQueueNode</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">listNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">listNode</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">listNode</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">//上锁处理多线程的问题    </span>
    <span class="n">SDL_LockMutex</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
    
    <span class="c1">//指针操作，如果是第一个节点直接复制到头指针</span>
    <span class="c1">//否则将新节点放到最后一个节点的next    </span>
    <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">first_pk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">queue</span><span class="o">-&gt;</span><span class="n">first_pk</span> <span class="o">=</span> <span class="n">listNode</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="p">((</span><span class="n">JDCQueueNode</span> <span class="o">*</span><span class="p">)</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">last_pk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">listNode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//更新尾指针 </span>
    <span class="n">queue</span><span class="o">-&gt;</span><span class="n">last_pk</span> <span class="o">=</span> <span class="n">listNode</span><span class="p">;</span>
    <span class="n">queue</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">++</span><span class="p">;</span>
    
    <span class="c1">//发信号唤醒等待线程    </span>
    <span class="n">SDL_CondSignal</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">);</span>
    <span class="c1">//解锁</span>
    <span class="n">SDL_UnlockMutex</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>然后是pop操作，将第一个元素拿出来，然后将其从队列中移除：</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="nf">jdc_packet_queue_pop</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="c1">//加锁</span>
    <span class="n">SDL_LockMutex</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">first_pk</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//取出第一个元素</span>
        <span class="n">JDCQueueNode</span> <span class="o">*</span><span class="n">firstPkl</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">first_pk</span><span class="p">;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">firstPkl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
        <span class="c1">//更新指针</span>
        <span class="n">queue</span><span class="o">-&gt;</span><span class="n">first_pk</span> <span class="o">=</span> <span class="n">firstPkl</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="n">queue</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">--</span><span class="p">;</span>
        
        <span class="c1">//因为链表node是动态分配内存，需要释放</span>
        <span class="n">free</span><span class="p">(</span><span class="n">firstPkl</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">SDL_UnlockMutex</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>再来看可阻塞的的获取数据方法：</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//这个方法尝试获取队列第一个元素，如果存在则立即返回。如果队列为空而且Block为1的时候会阻塞</span>
<span class="kt">int</span> <span class="nf">jdc_packet_queue_get_packet</span><span class="p">(</span><span class="n">JDCSDLPacketQueue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">data</span> <span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    
    <span class="n">SDL_LockMutex</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
    <span class="c1">//在这个无限循环中我尝试获取第一个数据</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">//如果拿到数据立即返回，否则挂起等待信号      </span>
        <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">first_pk</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">jdc_packet_queue_pop</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">block</span><span class="p">){</span>
            <span class="n">SDL_CondWait</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">SDL_UnlockMutex</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="总结">总结</h2>
<p>这样我们就实现了一个通用的可阻塞等待队列了。我们可以在没有数据的时候先将线程挂起，有数据的时候自动唤醒继续执行。完整代码请参考<a href="https://github.com/nightwolf-chen/JDCFFPlayer/blob/master/JDCFFMedia/jdc_sdl_queue.c">jdc_sdl_queue.c</a>。</p>
